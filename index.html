<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Interactivo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <style>
    body { margin:0; padding:0; display:flex; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 75%; }
    #info { width: 25%; padding: 10px; background: #f8f8f8; overflow-y: auto; }
    h2 { margin-top: 0; }
    label { display:block; margin-top: 10px; }
    input, select { width: 90%; padding: 5px; margin-top: 2px; }
    button { margin-top: 10px; padding: 5px 10px; cursor: pointer; }
    #addLocation { margin-bottom:10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <h2>Informaci칩n del punto/pol칤gono</h2>
    <p>Haz click en un elemento para editar sus datos.</p>
    <button id="addLocation">游늸 Agregar ubicaci칩n</button>
    <form id="featureForm" style="display:none;">
      <label>Circuito:<input type="text" id="circuito"></label>
      <label>Partido:
        <select id="partido">
          <option value="Milei">Milei</option>
          <option value="Massa">Massa</option>
          <option value="Bulrich">Bulrich</option>
        </select>
      </label>
      <label>Votos:<input type="number" id="votos"></label>
      <label>A침o de la elecci칩n:<input type="number" id="anio" value="2023" readonly></label>
      <button type="button" id="saveFeature">Guardar</button>
      <button type="button" id="cancelEdit">Cancelar</button>
    </form>
    <button id="downloadGeoJSON">Descargar GeoJSON</button>
    <button id="printMap">Imprimir Mapa</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script>
    const map = L.map('map').setView([-26.8241, -65.2227], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const featuresCollection = L.featureGroup().addTo(map);
    let selectedFeature = null;
    let addingLocation = false;

    const defaultStyle = { color: "#3388ff", weight: 2, fillOpacity: 0.2 };

    fetch('map.geojson')
      .then(res => res.json())
      .then(data => {
        const geojsonLayer = L.geoJSON(data, { style: defaultStyle }).addTo(featuresCollection);

        data.features.forEach(feature => {
          if (feature.geometry.type === "Polygon") {
            const coords = feature.geometry.coordinates[0];
            let latSum=0,lngSum=0;
            coords.forEach(c=>{lngSum+=c[0];latSum+=c[1];});
            const lat=latSum/coords.length;
            const lng=lngSum/coords.length;
            const marker = L.circleMarker([lat,lng], { radius:6, color:'red', fillOpacity:0.8 }).addTo(featuresCollection);
            marker.data = feature.properties || {};
            marker.on('click', () => editFeature(marker));
            const layer = geojsonLayer.getLayers().find(l => l.feature === feature);
            layer.data = feature.properties || {};
            layer.on('click', () => editFeature(layer));
          }
        });

        map.fitBounds(featuresCollection.getBounds());
      });

    const drawControl = new L.Control.Draw({
      edit: { featureGroup: featuresCollection },
      draw: { polygon:{allowIntersection:false, showArea:true}, rectangle:true, circle:false, polyline:false, marker:false }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function(e) {
      const layer = e.layer;
      layer.data = { circuito:'', partido:'Milei', votos:0, anio:2023 };
      layer.on('click', () => editFeature(layer));
      featuresCollection.addLayer(layer);
    });

    function editFeature(layer) {
      selectedFeature = layer;
      const form = document.getElementById('featureForm');
      form.style.display='block';
      document.getElementById('circuito').value = layer.data.circuito || '';
      document.getElementById('partido').value = layer.data.partido || 'Milei';
      document.getElementById('votos').value = layer.data.votos || 0;
      document.getElementById('anio').value = layer.data.anio || 2023;
    }

    document.getElementById('saveFeature').addEventListener('click', () => {
      if(!selectedFeature) return;
      selectedFeature.data.circuito = document.getElementById('circuito').value;
      selectedFeature.data.partido = document.getElementById('partido').value;
      selectedFeature.data.votos = parseInt(document.getElementById('votos').value) || 0;
      selectedFeature.data.anio = 2023;
      document.getElementById('featureForm').style.display='none';
      selectedFeature=null;
    });

    document.getElementById('cancelEdit').addEventListener('click', () => {
      document.getElementById('featureForm').style.display='none';
      selectedFeature=null;
    });

    document.getElementById('addLocation').addEventListener('click', () => {
      addingLocation = true;
      map.getContainer().style.cursor='crosshair';
    });

    map.on('click', function(e) {
      if(!addingLocation) return;
      const marker = L.circleMarker(e.latlng, { radius:6, color:'red', fillOpacity:0.8 }).addTo(featuresCollection);
      marker.data = { circuito:'', partido:'Milei', votos:0, anio:2023 };
      marker.on('click', () => editFeature(marker));
      editFeature(marker);
      addingLocation=false;
      map.getContainer().style.cursor='';
    });

    document.getElementById('downloadGeoJSON').addEventListener('click', () => {
      const geojson = featuresCollection.toGeoJSON();
      geojson.features.forEach(f => {
        const layer = featuresCollection.getLayers().find(l => l.feature === f || l === f);
        if(layer && layer.data) Object.assign(f.properties, layer.data);
      });
      const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(geojson,null,2));
      const a=document.createElement('a');
      a.setAttribute('href',dataStr);
      a.setAttribute('download','map.geojson');
      a.click();
    });

    document.getElementById('printMap').addEventListener('click',()=>window.print());
  </script>
</body>
</html>